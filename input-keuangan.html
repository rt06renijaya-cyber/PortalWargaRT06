<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Input Keuangan RT 06</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* (CSS sama persis seperti yang sudah Anda pakai) */
:root{
  --primary:#005c5c; --primary-dark:#004d40; --accent:#e76f51;
  --success:#28a745; --error:#dc3545; --bg:#f8fafc; --card:#fff;
  --text-color:#333; --muted-color:#6c757d; --loading:#d97706;
  --shadow-color: rgba(0,0,0,0.15); --menu-btn:#6c757d; --menu-btn-hover:#5a6268;
}
*{box-sizing:border-box}
body{ margin:0; font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text-color); -webkit-font-smoothing:antialiased; min-height:100vh; display:flex; flex-direction:column;}
.container{max-width:800px;margin:0 auto;padding:0 20px;flex-grow:1;}
.header-elegant{background:linear-gradient(135deg,#003636,var(--primary));color:white;padding:50px 20px 70px 20px;border-bottom-left-radius:60px;border-bottom-right-radius:60px;position:relative;box-shadow:0 10px 30px rgba(0,0,0,0.4);text-align:center;overflow:hidden;}
.header-elegant::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="p" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 0 0 L 10 10 M 10 0 L 0 10" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23p)"/></svg>') repeat;opacity:0.2;z-index:1;}
.header-content{position:relative;z-index:3;}
.header-content h1{font-size:2.5em;font-weight:700;margin:0 0 5px 0;text-shadow:0 2px 4px rgba(0,0,0,0.3);}
.header-content p{font-size:1em;opacity:0.9;margin:0;}
.form-card{background:var(--card);padding:40px;border-radius:15px;box-shadow:0 8px 25px var(--shadow-color);margin-top:-40px;position:relative;}
label{display:block;margin-bottom:8px;font-weight:600;font-size:1.1em;color:var(--primary-dark);text-align:left;}
input[type="date"],input[type="text"],input[type="number"],select{width:100%;padding:12px 15px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;font-size:1em;transition:border-color .3s,box-shadow .3s;box-sizing:border-box;text-align:left;}
input:focus,select:focus{border-color:#007bff;box-shadow:0 0 8px rgba(0,123,255,.2);outline:none;}
.form-group{margin-bottom:20px;}
.btn-group{display:flex;gap:15px;margin-top:20px;}
button{flex:1;padding:15px 10px;border:none;border-radius:50px;font-weight:600;cursor:pointer;transition:background-color .3s,transform .3s,box-shadow .3s;color:white;font-size:1.1em;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:8px;}
#submitIn{background:var(--primary);box-shadow:0 6px 15px rgba(0,92,92,.4);}
#submitIn:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,92,92,.6);}
#submitOut{background:var(--accent);box-shadow:0 4px 12px rgba(231,111,81,.3);}
#submitOut:hover{background:#d4654a;transform:translateY(-2px);box-shadow:0 6px 15px rgba(231,111,81,.5);}
.menu-btn-container{margin-top:30px;text-align:center;}
.menu-link{display:inline-flex;align-items:center;justify-content:center;padding:12px 25px;background-color:var(--menu-btn);color:white;text-decoration:none;border-radius:50px;font-weight:600;font-size:1em;transition:background-color .3s,transform .3s,box-shadow .3s;gap:8px;box-shadow:0 4px 10px rgba(0,0,0,.15);}
.notification{padding:15px;border-radius:8px;margin-top:25px;font-weight:600;display:none;align-items:center;gap:10px;animation:slideIn .3s ease-out;}
.success{background:#d4edda;color:var(--success);border:1px solid var(--success);}
.error{background:#f8d7da;color:var(--error);border:1px solid var(--error);}
.loading{background:#fff3cd;color:var(--loading);border:1px solid var(--loading);}
@keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
#koordinatorGroup{transition:all .3s ease-in-out;overflow:hidden;height:0;opacity:0;padding-top:0;}
#koordinatorGroup.show{height:auto;opacity:1;padding-top:10px;}
#subKeamananWrapper{transition:all .25s ease;overflow:hidden;height:0;opacity:0;padding-top:0;}
#subKeamananWrapper.show{height:auto;opacity:1;padding-top:10px;}
.custom-alert{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000;opacity:0;transition:opacity .3s ease;}
.custom-alert.show{display:flex;opacity:1;}
.alert-content{background-color:white;padding:40px 30px;border-radius:15px;max-width:320px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,.4);transform:scale(.7);transition:transform .4s cubic-bezier(.68,-.55,.265,1.55);}
.custom-alert.show .alert-content{transform:scale(1);}
.alert-icon{font-size:5em;margin-bottom:20px;animation:pulse 1.5s infinite;}
.alert-success .alert-icon{color:var(--success);text-shadow:0 0 15px rgba(40,167,69,.5);}
.alert-error .alert-icon{color:var(--error);text-shadow:0 0 15px rgba(220,53,69,.5);}
.alert-content h3{margin:0 0 10px 0;font-size:1.8em;font-weight:700;color:#333;}
.alert-content p{margin:0 0 25px 0;color:#6c757d;font-size:1em;}
.alert-btn{background-color:#007bff;color:white;padding:10px 25px;border:none;border-radius:50px;cursor:pointer;font-weight:600;}
.alert-btn:hover{background-color:#0056b3;transform:translateY(-2px);}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
.footer{background:linear-gradient(135deg,#002e28,var(--primary-dark));color:#e0ffff;text-align:center;padding:40px 15px;border-top-left-radius:30px;border-top-right-radius:30px;box-shadow:0 -5px 15px rgba(0,0,0,.2);margin-top:50px;}
.footer p{margin:5px 0;font-size:.9em;opacity:.9;}
.footer a{color:#ffc107;text-decoration:none;transition:color .3s;}
.footer a:hover{color:#fff;}
@media(max-width:768px){.form-card{padding:30px 20px}.header-content h1{font-size:2em}.btn-group{flex-direction:column}button{width:100%}}
</style>
</head>
<body>

<div class="header-elegant">
  <div class="header-content">
    <h1><i class="fas fa-file-invoice-dollar"></i> Input Transaksi Keuangan RT 06</h1>
    <p id="form-description">Masukkan rincian transaksi (Pemasukan atau Pengeluaran) untuk dicatat di Google Sheet.</p>
  </div>
</div>

<div class="container">
  <div class="form-card">
    <form id="financeForm">
      <div class="form-group">
        <label for="tanggal">Tanggal Transaksi</label>
        <input type="date" id="tanggal" name="Tanggal" required />
      </div>

      <div class="form-group">
        <label for="kategori">Kategori</label>
        <select id="kategori" name="Kategori" required>
          <option value="" disabled selected>Pilih Kategori Transaksi</option>
          <option value="Saldo Bulan Sebelumnya">Saldo Bulan Sebelumnya</option>
          <option value="Iuran Warga">Iuran Warga</option>
          <option value="Donasi">Donasi/Sumbangan</option>
          <option value="Kas Sosial">Kas Sosial</option>
          <option value="Kegiatan">Kegiatan/Acara</option>
          <option value="Kebersihan">Kebersihan</option>
          <option value="Keamanan">Keamanan</option>
          <option value="Keamanan">Operasional RT.</option>
          <option value="Lainnya">Lainnya</option>
        </select>
      </div>

      <!-- Sub pilihan untuk Keamanan -->
      <div class="form-group" id="subKeamananWrapper">
        <label for="subKeamanan">Jenis Keamanan</label>
        <select id="subKeamanan" name="SubKeamanan">
          <option value="" selected>-- Pilih Jenis Keamanan --</option>
          <option value="Keamanan Pagi">Keamanan Pagi</option>
          <option value="Keamanan Malam">Keamanan Malam</option>
        </select>
      </div>

      <div class="form-group" id="koordinatorGroup">
        <label for="koordinator">Koordinator Gang (Hanya untuk Iuran Warga)</label>
        <select id="koordinator" name="Koordinator" disabled>
          <option value="" selected disabled>Memuat daftar koordinator...</option>
        </select>
      </div>

      <div class="form-group">
        <label for="keterangan">Keterangan / Detail</label>
        <input type="text" id="keterangan" name="Keterangan" placeholder="Contoh: Iuran rutin bulan November, Beli sapu dan pel" required />
      </div>

      <div class="form-group">
        <label for="nominal">Nominal (Hanya Angka, cth: 50000)</label>
        <input type="number" id="nominal" name="Nominal" placeholder="Masukkan jumlah dalam Rupiah (tanpa titik atau koma)" required min="1" />
      </div>

      <div class="btn-group">
        <button type="button" id="submitIn" data-sheet="web_Pemasukan"><i class="fas fa-plus-circle"></i> Pemasukan</button>
        <button type="button" id="submitOut" data-sheet="web_Pengeluaran"><i class="fas fa-minus-circle"></i> Pengeluaran</button>
      </div>
    </form>

    <div id="notification" class="notification"></div>

    <div class="menu-btn-container">
      <a href="#" id="menuLinkAbove" class="menu-link"><i class="fas fa-home"></i> Kembali ke Menu Utama</a>
    </div>
  </div>
</div>

<div id="resultAlert" class="custom-alert">
  <div class="alert-content">
    <i class="alert-icon"></i>
    <h3 id="alert-title"></h3>
    <p id="alert-message"></p>
    <button class="alert-btn" onclick="closeCustomAlert('resultAlert')">OK, Mengerti</button>
  </div>
</div>

<footer class="footer">
  <p><a href="#" id="menuLinkFooter"><i class="fas fa-home"></i> Menu Utama</a> | &copy; 2025 RT 06 Management System</p>
  <p>Ditenagai oleh Google Apps Script & HTML</p>
</footer>

<script>
// ====== Sesuaikan URL Web App Anda di sini ======
const ENDPOINT_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbyo5NqfEOTx_0KPwZ56Yixj1NK2mqpdAjKFoiJuScADb8plc7gwxtmgZbAW6FACPXJr/exec";
const MAIN_MENU_URL = "pengurus06.html";

const form = document.getElementById('financeForm');
const loadingNotification = document.getElementById('notification');
const submitInBtn = document.getElementById('submitIn');
const submitOutBtn = document.getElementById('submitOut');
const kategoriSelect = document.getElementById('kategori');
const subKeamananWrapper = document.getElementById('subKeamananWrapper');
const subKeamananSelect = document.getElementById('subKeamanan');
const koordinatorGroup = document.getElementById('koordinatorGroup');
const koordinatorSelect = document.getElementById('koordinator');
const keteranganInput = document.getElementById('keterangan');
const formDescription = document.getElementById('form-description');
const nominalInput = document.getElementById('nominal');

document.getElementById('menuLinkAbove').href = MAIN_MENU_URL;
document.getElementById('menuLinkFooter').href = MAIN_MENU_URL;

let koordinatorDataLoaded = false;
let isSaldoMode = false;

// Custom alert helpers
function closeCustomAlert(id){ document.getElementById(id).classList.remove('show'); }
function showCustomAlert(id,title,message,isSuccess=true){
  const el = document.getElementById(id);
  const icon = el.querySelector('.alert-icon');
  el.classList.remove('alert-success','alert-error');
  el.classList.add(isSuccess? 'alert-success':'alert-error');
  icon.className = isSuccess? 'alert-icon fas fa-check-circle':'alert-icon fas fa-times-circle';
  el.querySelector('#alert-title').textContent = title;
  el.querySelector('#alert-message').innerHTML = message;
  el.classList.add('show');
}

// Kategori change logic (menampilkan sub-keamanan & koordinator)
kategoriSelect.addEventListener('change', function(){
  const selected = this.value;
  // reset
  submitInBtn.style.display = 'flex';
  submitOutBtn.style.display = 'flex';
  submitInBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Pemasukan';
  submitOutBtn.innerHTML = '<i class="fas fa-minus-circle"></i> Pengeluaran';
  submitInBtn.setAttribute('data-sheet','web_Pemasukan');
  nominalInput.min = "1";
  formDescription.textContent = 'Masukkan rincian transaksi (Pemasukan atau Pengeluaran) untuk dicatat di Google Sheet.';
  subKeamananWrapper.classList.remove('show');
  subKeamananSelect.value = "";
  koordinatorGroup.classList.remove('show');
  koordinatorSelect.required = false;
  koordinatorSelect.disabled = true;
  koordinatorSelect.value = "";
  isSaldoMode = false;

  if (selected === 'Iuran Warga' && koordinatorDataLoaded){
    koordinatorGroup.classList.add('show');
    koordinatorSelect.required = true;
    koordinatorSelect.disabled = false;
    keteranganInput.placeholder = "Cth: Iuran rutin bulan November 2025";
  } else if (selected === 'Saldo Bulan Sebelumnya'){
    isSaldoMode = true;
    submitOutBtn.style.display = 'none';
    submitInBtn.innerHTML = '<i class="fas fa-money-check-alt"></i> Input Saldo Awal';
    submitInBtn.setAttribute('data-sheet','web_SaldoAwal');
    submitInBtn.disabled = false;
    nominalInput.min = "0";
    keteranganInput.placeholder = "Contoh: Saldo Akhir Oktober 2025";
    formDescription.textContent = 'Mode Saldo Awal: Data akan dicatat sebagai Saldo Awal Bulanan.';
    // prefill keterangan saldo akhir bulan sebelumnya
    const today = new Date(document.getElementById('tanggal').value || Date.now());
    const d = new Date(today.getFullYear(), today.getMonth(), 1); d.setMonth(d.getMonth() - 1);
    const monthNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    keteranganInput.value = `Saldo Akhir ${monthNames[d.getMonth()]} ${d.getFullYear()}`;
  } else if (selected === 'Keamanan') {
    subKeamananWrapper.classList.add('show');
  } else {
    keteranganInput.placeholder = "Contoh: Beli sapu dan pel, Donasi untuk korban banjir";
  }
});

submitInBtn.addEventListener('click', ()=> submitForm(submitInBtn));
submitOutBtn.addEventListener('click', ()=> submitForm(submitOutBtn));

// Loading notification helper
function showLoadingNotification(message,type){
  const iconClass = type === 'success' ? 'fas fa-check-circle' : (type === 'error' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle');
  loadingNotification.innerHTML = `<i class="${iconClass}"></i> ${message}`;
  loadingNotification.className = `notification ${type}`;
  loadingNotification.style.display = 'flex';
  if (type !== 'loading'){
    setTimeout(()=> loadingNotification.style.display = 'none',5000);
  }
}

// Ambil daftar koordinator dari Apps Script
async function fetchKoordinatorList(){
  showLoadingNotification("Memuat daftar Koordinator...","loading");
  submitInBtn.disabled = true; submitOutBtn.disabled = true;
  try {
    const res = await fetch(`${ENDPOINT_APPS_SCRIPT}?action=getKoordinator`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const txt = await res.text();
    const data = JSON.parse(txt);
    koordinatorSelect.innerHTML = '<option value=\"\" selected disabled>Pilih Koordinator Gang</option>';
    if (data && data.koordinatorList && data.koordinatorList.length){
      data.koordinatorList.forEach(k=>{
        const opt = document.createElement('option'); opt.value = k; opt.textContent = k; koordinatorSelect.appendChild(opt);
      });
      koordinatorDataLoaded = true;
      showLoadingNotification("Daftar Koordinator berhasil dimuat.","success");
    } else {
      koordinatorSelect.innerHTML = '<option value=\"\" selected disabled>Tidak ada data koordinator ditemukan. Harap cek sheet ListKoordinator.</option>';
      showLoadingNotification("Daftar Koordinator dimuat, tetapi kosong.","error");
    }
  } catch(err){
    console.error(err);
    koordinatorSelect.innerHTML = '<option value=\"\" selected disabled>Gagal memuat data.</option>';
    showLoadingNotification("Gagal memuat daftar koordinator. Cek URL Apps Script atau jaringan.","error");
  } finally {
    submitInBtn.disabled = false; submitOutBtn.disabled = false;
    kategoriSelect.dispatchEvent(new Event('change'));
  }
}

/**
 * Submit form ke Apps Script
 * - Jika SubKeamanan dipilih -> jadikan data.Kategori = SubKeamanan
 * - Jika ada Koordinator -> GS akan gabungkan kategori menjadi "Iuran Warga - <Koordinator>"
 * - Jika SaldoAwal -> GS akan set keterangan Saldo akhir bulan sebelumnya bila kosong
 */
async function submitForm(button){
  if (!form.checkValidity()){
    form.reportValidity();
    showCustomAlert('resultAlert',"Formulir Tidak Lengkap","Mohon lengkapi semua data yang diperlukan pada formulir.",false); return;
  }
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  let targetSheet = button.getAttribute('data-sheet');

  // jika sub-keamanan dipilih -> jadikan kategori final
  if (data.SubKeamanan && data.SubKeamanan.trim() !== "") {
    data.Kategori = data.SubKeamanan;
    delete data.SubKeamanan;
  }

  // set sheet target (saldo mode sudah di-handle oleh data-sheet di tombol)
  data.Sheet = targetSheet;

  // Format tanggal ke DD/MM/YYYY (backend kita akan terima dd/mm/yyyy)
  if (data.Tanggal && data.Tanggal.includes('-')) {
    data.Tanggal = data.Tanggal.split('-').reverse().join('/');
  }

  // Nominal
  data.Nominal = parseInt(data.Nominal || data.nominal || 0);

  const originalIn = submitInBtn.innerHTML, originalOut = submitOutBtn.innerHTML;
  const isPemasukan = data.Sheet === 'web_Pemasukan' || data.Sheet === 'web_SaldoAwal';
  const typeLabel = (data.Sheet === 'web_SaldoAwal') ? 'Saldo Awal' : (isPemasukan ? 'Pemasukan' : 'Pengeluaran');

  submitInBtn.disabled = true; submitOutBtn.disabled = true;
  button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Mengirim...`;

  try {
    // Kami menggunakan mode no-cors di frontend sebelumnya â€” Apps Script tidak mengembalikan JSON yang dapat dibaca pada browser,
    // namun server tetap menerima request. Kita tetap kirim POST JSON.
    await fetch(ENDPOINT_APPS_SCRIPT, {
      method: 'POST',
      mode: 'no-cors',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });

    showCustomAlert(
      'resultAlert',
      "Transaksi Berhasil Dicatat!",
      `
        <div class="alert-text">
          <div class="alert-line">Data ${typeLabel.toLowerCase()} sebesar</div>
          <div class="alert-nominal">Rp ${data.Nominal.toLocaleString('id-ID')}</div>
          <div class="alert-line">berhasil tercatat di Google Sheet</div>
        </div>
      `,
      true
    );


    form.reset();
    kategoriSelect.dispatchEvent(new Event('change'));
  } catch (err) {
    console.error(err);
    showCustomAlert('resultAlert',"Kesalahan Jaringan/Server!",`Gagal mencatat data. Detail Error: ${err.message}. Cek koneksi atau URL Apps Script.`,false);
  } finally {
    submitInBtn.innerHTML = originalIn; submitOutBtn.innerHTML = originalOut;
    submitInBtn.disabled = false; submitOutBtn.disabled = false;
    kategoriSelect.dispatchEvent(new Event('change'));
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tanggal').value = today;
  subKeamananWrapper.classList.remove('show');
  fetchKoordinatorList();
});
</script>
</body>
</html>
