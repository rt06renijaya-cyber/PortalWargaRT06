<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Keuangan RT. 06 Reni Jaya</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<style>
:root{
  --primary-deep:#004d40; --primary-light:#005c5c;
  --success:#28a745; --error:#dc3545; --accent:#ffc107;
  --bg:#f8fafc; --card:#fff; --text:#343a40; --muted:#6c757d;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Poppins",sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.wrap{max-width:1200px;margin:-40px auto 30px;padding:0 15px;position:relative}
.header-elegant{background:linear-gradient(135deg,#003636,#005c5c);color:white;padding:50px 20px 80px 20px;border-bottom-left-radius:40px;border-bottom-right-radius:40px;position:relative}
.header-content{text-align:center}
.title-elegant{font-size:2em;font-weight:700;margin:0}
.slogan-elegant{margin-top:10px;font-size:0.9em;opacity:0.85;font-weight:300}
.form-select{padding:8px 15px;border-radius:8px;border:none;background:rgba(255,255,255,0.08);color:white;font-weight:600;margin-top:15px}
.card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:15px}
.summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
.summary-card{padding:15px;border-radius:10px;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.summary-card .value{font-weight:800;font-size:18px;margin-top:8px}
.transaction-table{width:100%;border-collapse:collapse;margin-top:10px}
.transaction-table th,.transaction-table td{padding:8px 10px;text-align:left;font-size:12px}
.transaction-table th{background:#f1f5f9;font-weight:700}
.inflow{color:var(--success);font-weight:600}
.outflow{color:var(--error);font-weight:600}
.pagination-controls{display:flex;justify-content:flex-end;align-items:center;margin-top:15px;gap:8px}
.pagination-controls button{background:var(--primary-light);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
.footer{padding:20px 15px;margin-top:30px;text-align:center}

@media(min-width:768px){.summary-grid{grid-template-columns:repeat(4,1fr)}}
.chart-wrapper{position:relative;height:320px;width:100%}
</style>
</head>
<body>

<header class="header-elegant">
  <div class="header-content">
    <h1 class="title-elegant"><i class="fas fa-hand-holding-usd"></i> Transparansi Keuangan RT. 06</h1>
    <p class="slogan-elegant">Laporan aliran kas, pemasukan, dan pengeluaran iuran RT bulan <span id="currentMonthYear">Memuat...</span> secara *real-time*.</p>
    <select id="periodSelector" class="form-select"><option>Memuat periode...</option></select>
  </div>
</header>

<main class="wrap">
  <div class="summary-grid">
    <div class="summary-card"><h4>SALDO KAS SAAT INI</h4><div class="value" id="saldoSaatIni">Memuat...</div><small id="statusSaldo"></small></div>
    <div class="summary-card"><h4>PEMASUKAN B.L.</h4><div class="value" id="pemasukanBulanIni">Memuat...</div><small><span id="jumlahPemasukan">0</span> transaksi</small></div>
    <div class="summary-card"><h4>PENGELUARAN B.L.</h4><div class="value" id="pengeluaranBulanIni">Memuat...</div><small><span id="jumlahPengeluaran">0</span> transaksi</small></div>
    <div class="summary-card"><h4>SALDO AWAL</h4><div class="value" id="saldoAwal">Memuat...</div><small>Diambil dari data saldo awal</small></div>
  </div>

  <div class="card">
    <h2>Perbandingan Aliran Kas</h2>
    <p>Perbandingan Total Pemasukan dan Pengeluaran Bulan Ini (<span id="labelBulanIni"></span>) vs Bulan Lalu (<span id="labelBulanLalu"></span>).</p>
    <div class="chart-wrapper"><canvas id="cashflowChart"></canvas></div>
  </div>

  <div class="card">
    <h2>Daftar Transaksi Pemasukan (<span id="countPemasukan">0</span>)</h2>
    <table class="transaction-table">
      <thead><tr><th>TANGGAL</th><th class="keterangan-col">KETERANGAN</th><th>KATEGORI</th><th>NOMINAL</th></tr></thead>
      <tbody id="tabelPemasukan"><tr><td colspan="4" style="text-align:center;color:#6c757d">Memuat data...</td></tr></tbody>
    </table>
    <div class="pagination-controls">
      <button id="prevIn">‹ Sebelumnya</button><span id="infoIn" style="align-self:center;margin:0 10px">Halaman 1</span><button id="nextIn">Selanjutnya ›</button>
    </div>
  </div>

  <div class="card">
    <h2>Daftar Transaksi Pengeluaran (<span id="countPengeluaran">0</span>)</h2>
    <table class="transaction-table">
      <thead><tr><th>TANGGAL</th><th class="keterangan-col">KETERANGAN</th><th>KATEGORI</th><th>NOMINAL</th></tr></thead>
      <tbody id="tabelPengeluaran"><tr><td colspan="4" style="text-align:center;color:#6c757d">Memuat data...</td></tr></tbody>
    </table>
    <div class="pagination-controls">
      <button id="prevOut">‹ Sebelumnya</button><span id="infoOut" style="align-self:center;margin:0 10px">Halaman 1</span><button id="nextOut">Selanjutnya ›</button>
    </div>
  </div>

  <div class="footer">&copy; 2025 RT. 06 — Portal Warga</div>
</main>

<script>
/* ============================
   CONFIG: ganti ini dengan URL Web App Anda
   ============================ */
const ENDPOINT_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbyn_YDqfl7Q7b16F8gIhY3MjRU1TqQVNzB2SrVQ-hpo029UrGNGyDoORVfPTB0wg2sVNQ/exec"; // <-- ganti

const ITEMS_PER_PAGE = 8;
const monthNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

let allInflow = [], allOutflow = [];
let inflowPage = 1, outflowPage = 1;
let chartInstance = null;

/* safe fetch + parse */
async function safeFetchJson(url){
  const res = await fetch(url, {cache: "no-store"});
  const txt = await res.text();
  try { return JSON.parse(txt); }
  catch(e) { throw new Error("Gagal parse JSON: " + e.message + " — " + txt.slice(0,200)); }
}

function formatRupiah(n){
  if (n === null || n === undefined || isNaN(Number(n))) return 'Rp 0';
  const v = Math.round(Number(n));
  return 'Rp ' + v.toLocaleString('id-ID');
}

function populatePeriodSelector(){
  const sel = document.getElementById('periodSelector');
  sel.innerHTML = '<option>Memuat periode...</option>';
  safeFetchJson(`${ENDPOINT_APPS_SCRIPT}?action=getAvailablePeriods`)
    .then(data => {
      if (!data || data.status !== 'success' || !Array.isArray(data.periods)) {
        sel.innerHTML = '<option value="">Tidak ada periode</option>';
        const now = new Date(); fetchDashboardData(now.getMonth()+1, now.getFullYear()); return;
      }
      sel.innerHTML = '';
      data.periods.forEach((p, idx) => {
        const [y,m] = p.split('-');
        const opt = document.createElement('option'); opt.value = p;
        opt.textContent = monthNames[parseInt(m,10)-1] + ' ' + y;
        if (idx === 0) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.addEventListener('change', () => {
        const [y,m] = sel.value.split('-'); inflowPage = 1; outflowPage = 1; fetchDashboardData(Number(m), Number(y));
      });
      const [dy, dm] = data.periods[0].split('-');
      fetchDashboardData(Number(dm), Number(dy));
    })
    .catch(err => {
      console.error(err);
      sel.innerHTML = '<option>Gagal memuat periode</option>';
      const now = new Date(); fetchDashboardData(now.getMonth()+1, now.getFullYear());
    });
}

async function fetchDashboardData(month, year){
  document.getElementById('saldoSaatIni').textContent = 'Memuat...';
  const url = `${ENDPOINT_APPS_SCRIPT}?action=getDashboard&month=${Number(month)}&year=${Number(year)}`;
  try {
    const data = await safeFetchJson(url);
    if (!data || data.status !== 'success') throw new Error(data?.message || 'Response tidak valid');
    const periodInfo = data.periodInfo || {};
    const monthName = periodInfo.monthName || monthNames[(periodInfo.month||month)-1];
    const yearNum = periodInfo.year || year;
    document.getElementById('currentMonthYear').textContent = monthName + ' ' + yearNum;
    document.getElementById('labelBulanIni').textContent = monthName;
    // prev month label
    try { const t = new Date(yearNum, (periodInfo.month||month)-1, 1); const p = new Date(t.getFullYear(), t.getMonth()-1, 1); document.getElementById('labelBulanLalu').textContent = monthNames[p.getMonth()]; } catch(e){}

    // summary
    const summary = data.summary || {};
    document.getElementById('saldoSaatIni').textContent = formatRupiah(summary.currentBalance || 0);
    document.getElementById('pemasukanBulanIni').textContent = formatRupiah(summary.totalInflow || 0);
    document.getElementById('jumlahPemasukan').textContent = summary.inflowCount || 0;
    document.getElementById('pengeluaranBulanIni').textContent = formatRupiah(summary.totalOutflow || 0);
    document.getElementById('jumlahPengeluaran').textContent = summary.outflowCount || 0;
    document.getElementById('saldoAwal').textContent = formatRupiah(summary.previousMonthBalance || 0);

    // chart
    const comp = data.monthlyComparison || {};
    const thisM = comp.thisMonth || {inflow:0, outflow:0};
    const prevM = comp.prevMonth || {inflow:0, outflow:0};
    updateChart({
      labels: ['Pemasukan','Pengeluaran'],
      current: [thisM.inflow||0, thisM.outflow||0],
      previous: [prevM.inflow||0, prevM.outflow||0]
    }, monthName, document.getElementById('labelBulanLalu').textContent);

    // transactions
    const tx = Array.isArray(data.allTransactions) ? data.allTransactions : [];
    // data shape from GS: { tanggal, keterangan, kategori, nominal, type }
    const normalized = tx.map(t => ({
      tanggal: t.tanggal || '',
      keterangan: t.keterangan || '',
      kategori: t.kategori || '',
      nominal: Number(t.nominal || 0),
      jenis: t.type || t.type || ''
    }));
    allInflow = normalized.filter(x => x.jenis === 'Pemasukan');
    allOutflow = normalized.filter(x => x.jenis === 'Pengeluaran');
    document.getElementById('countPemasukan').textContent = allInflow.length;
    document.getElementById('countPengeluaran').textContent = allOutflow.length;

    inflowPage = 1; outflowPage = 1;
    renderTablePage('in', allInflow, inflowPage);
    renderTablePage('out', allOutflow, outflowPage);

    // statusSaldo color
    const statusEl = document.getElementById('statusSaldo');
    if (summary.currentBalance < 1000000) { statusEl.textContent = 'Perlu Prioritas Kas'; statusEl.style.color = 'var(--error)'; }
    else { statusEl.textContent = 'Baik'; statusEl.style.color = 'var(--success)'; }

  } catch (err) {
    console.error(err);
    document.getElementById('saldoSaatIni').textContent = 'Gagal memuat: ' + (err.message || err);
  }
}

function renderTablePage(type, arr, page){
  const tbody = (type === 'in') ? document.getElementById('tabelPemasukan') : document.getElementById('tabelPengeluaran');
  const info = (type === 'in') ? document.getElementById('infoIn') : document.getElementById('infoOut');
  const prev = (type === 'in') ? document.getElementById('prevIn') : document.getElementById('prevOut');
  const next = (type === 'in') ? document.getElementById('nextIn') : document.getElementById('nextOut');
  tbody.innerHTML = '';
  if (!Array.isArray(arr) || arr.length === 0) {
    const tr = tbody.insertRow(); tr.innerHTML = `<td colspan="4" style="text-align:center;color:#6c757d">Belum ada transaksi</td>`;
    if (info) info.textContent = 'Halaman 0';
    if (prev) prev.disabled = true; if (next) next.disabled = true;
    return;
  }
  const totalPages = Math.ceil(arr.length / ITEMS_PER_PAGE);
  if (page < 1) page = 1; if (page > totalPages) page = totalPages;
  const start = (page - 1) * ITEMS_PER_PAGE;
  const pageItems = arr.slice(start, start + ITEMS_PER_PAGE);
  pageItems.forEach(it => {
    const tr = tbody.insertRow();
    tr.insertCell().textContent = it.tanggal || '';
    const kd = tr.insertCell(); kd.className = 'keterangan-col'; kd.textContent = it.keterangan || '';
    tr.insertCell().textContent = it.kategori || '';
    const nom = tr.insertCell(); nom.className = (type==='in')?'inflow':'outflow'; nom.textContent = formatRupiah(it.nominal);
  });
  if (info) info.textContent = `Menampilkan ${start+1}-${Math.min(start+pageItems.length, arr.length)} dari ${arr.length}`;
  if (prev) prev.disabled = page <= 1;
  if (next) next.disabled = page >= totalPages;
  if (type === 'in') inflowPage = page; else outflowPage = page;
}

document.getElementById('prevIn').addEventListener('click', ()=>{ if (inflowPage>1){ inflowPage--; renderTablePage('in', allInflow, inflowPage);} });
document.getElementById('nextIn').addEventListener('click', ()=>{ inflowPage++; renderTablePage('in', allInflow, inflowPage); });
document.getElementById('prevOut').addEventListener('click', ()=>{ if (outflowPage>1){ outflowPage--; renderTablePage('out', allOutflow, outflowPage);} });
document.getElementById('nextOut').addEventListener('click', ()=>{ outflowPage++; renderTablePage('out', allOutflow, outflowPage); });

function updateChart(data, thisMonthName, prevMonthName){
  const ctx = document.getElementById('cashflowChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.labels || ['Pemasukan','Pengeluaran'],
      datasets: [
        { label: `Bulan Ini (${thisMonthName})`, data: data.current || [0,0], backgroundColor: 'rgba(40,167,69,0.9)', borderRadius:6 },
        { label: `Bulan Lalu (${prevMonthName})`, data: data.previous || [0,0], backgroundColor: 'rgba(220,53,69,0.9)', borderRadius:6 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{position:'top'}, tooltip:{callbacks:{label:function(ctx){ return ctx.dataset.label + ': ' + formatRupiah(ctx.parsed.y); }}}},
      scales:{ y:{ beginAtZero:true, ticks:{ callback: v => { if (Math.abs(v) >= 1000000) return (v/1000000) + ' Jt'; if (Math.abs(v) >= 1000) return (v/1000) + ' K'; return v; }}}}
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  populatePeriodSelector();
});
</script>
</body>
</html>
